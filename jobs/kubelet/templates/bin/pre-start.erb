#!/bin/bash -exu

CONFIG_DIR=/var/vcap/jobs/kubelet/config

SIGN_CMD=/var/vcap/packages/local-sign/bin/local-sign
CA_CONFIG_PATH="${CONFIG_DIR}/kubelet_ca_config.yml"
CERTIFICATE_TEMPLATE_PATH="${CONFIG_DIR}/kubelet_certificate_template.yml"
CERTIFICATE_OUTPUT_DIR="${CONFIG_DIR}/out"

# NODE_IP="<%= spec.ip %>"
# BOSH_ID="<%= spec.id %>"
# DEPOLYMENT_NAME="<%= spec.deployment %>"
# CLUSTER_UUID=$(echo "${DEPOLYMENT_NAME}" | cut -d'_' -f 2)

KUBELET_CERT_PATH="${CONFIG_DIR}/kubelet.pem"
KUBELET_KEY_PATH="${CONFIG_DIR}/kubelet-key.pem"

CONFIG_FILE_NAME="${CONFIG_DIR}/file-arguments.json"


do_kubelet_certificate_sign(){
    set +e
    sed -i "s|NODENAME|$(hostname)|g" ${CERTIFICATE_TEMPLATE_PATH}
    $(${SIGN_CMD} certificate --config ${CA_CONFIG_PATH} --template ${CERTIFICATE_TEMPLATE_PATH} --out ${CERTIFICATE_OUTPUT_DIR})
    mv ${CERTIFICATE_OUTPUT_DIR}/certificate.pem ${KUBELET_CERT_PATH}
    mv ${CERTIFICATE_OUTPUT_DIR}/key.pem ${KUBELET_KEY_PATH}
    rmdir ${CERTIFICATE_OUTPUT_DIR}
    set -e 
}

main(){
    if [ -f $CONFIG_FILE_NAME ]; then
        chmod +x /var/vcap/packages/file-generator/bin/file_generator
        /var/vcap/packages/file-generator/bin/file_generator $CONFIG_FILE_NAME kubelet
    fi

    mount --make-rshared /

    ## Sign kubelet certificate for the first boot
    echo "$(date '+%Y/%m/%d %H:%M:%S'): Start to sign kubelet certificate..."
    do_kubelet_certificate_sign
}

main
