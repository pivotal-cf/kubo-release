#!/bin/bash

set -ex

mkdir -p /etc/security/limits.d

cat << EOF > /etc/security/limits.d/62-ulimit.conf
# Do not edit this file; it will be overwritten.
# Created by the pre-start script of the BOSH job "containerd"
* soft nofile 65535
* hard nofile 65535
EOF

monit_pid=$( ps -e | grep -w monit | awk '{print $1}' )

if [ ! -z "$monit_pid" ]; then
  prlimit --pid $monit_pid --nofile=65535:65535
fi

/sbin/modprobe overlay
/sbin/modprobe br_netfilter

# Having non-zero Limit*s causes performance problems due to accounting overhead
# in the kernel. We recommend using cgroups to do container-local accounting.
LimitNPROC=infinity
LimitCORE=infinity
LimitNOFILE=1048576
# Comment TasksMax if your systemd version does not supports it.
# Only systemd 226 and above support this version.
TasksMax=infinity
OOMScoreAdjust=-999
