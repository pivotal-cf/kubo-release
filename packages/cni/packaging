set -exu

mkdir -p ${BOSH_INSTALL_TARGET}/bin

CNI_PACKAGE="cni-plugins"
CNI_VERSION="0.7.1"

tar -xzf cni/${CNI_PACKAGE}-amd64-${CNI_VERSION}.tgz -C ${BOSH_INSTALL_TARGET}/bin/

# sadly, the binaries just copied do NOT have the release's version number burned in to them,
# so we must extract version from the tarball just expanded and pass that along via a text file
REGEX='.*cni-plugins-amd64-([a-zA-Z\.0-9]+)\.tgz.*'
[[ "$(ls cni/cni-plugins-amd64*.tgz)" =~ $REGEX ]]
echo ${BASH_REMATCH[1]} > ${BOSH_INSTALL_TARGET}/bin/BOSHCYCLE_CNI_RELEASE_VERSION

mkdir -p utillocal
dpkg -x cni/util-linux*.deb utillocal/

cp utillocal/usr/bin/nsenter ${BOSH_INSTALL_TARGET}/bin

chmod +x ${BOSH_INSTALL_TARGET}/bin/*


# Open Source Licensing Information, used by the vmware OSM system
# These license abbreviations are defined by the OSM system
# See https://github.com/pivotal-cf/pks-bosh-lifecycle-home/tree/master/osl/osm-blob-manifests

CNI_LICENSE="Apache2.0"
CNI_SOURCE_URL="https://github.com/containernetworking/cni/archive/v0.7.1.tar.gz"

cat <<EOF > ${BOSH_INSTALL_TARGET}/boshcycle_osm.json
{ "packages": [
    {
    "name": "$CNI_PACKAGE",
    "version": "$CNI_VERSION",
    "url": "$CNI_SOURCE_URL",
    "license": "$CNI_LICENSE"
    }
]}
EOF
